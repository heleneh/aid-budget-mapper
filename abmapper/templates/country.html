{% set active_page='index' %}{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<script >
    $(function() {
    $("table#projects").tablesorter({ sortList: [[5,1]] });
    $("table#budget-lines").tablesorter({ sortList: [[0,0]] });
    });
</script>
<br />
<div class="pull-right">
    <a class="btn btn-success" href="{{url_for('activity_export', country_code=country.code)}}">
        <b><span class="glyphicon glyphicon-save" aria-hidden="true"></span> Export</b>
    </a>
    {% for ro in reporting_orgs %}
    <a class="btn btn-default" href="{{url_for('activity_export', country_code=country.code, reporting_org=ro.reporting_org)}}">
        <b><span class="glyphicon glyphicon-save" aria-hidden="true"></span> Export {{ro.reporting_org}} ({{ro.num_activities}})</b>
    </a>
    {% endfor %}
</div>
<h2>Mapping statistics</h2>
<dl class="dl-horizontal">
  <dt>Total value</dt><dd>{{stats.total_value}}
</dl>
<h3>Administrative/functional classification</h3>
<dl class="dl-horizontal">
  <dt>Before</dt><dd>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{stats.total_mappable_before_pct}}%;">
        <span><b>{{stats.total_mappable_before_pct}}% Mappable</b></span>
      </div>
    </div>
  </dd>
  <dt>After</dt><dd>
    <div class="progress">
      <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{stats.total_mappable_after_pct}}%;">
        <span><b>{{stats.total_mappable_after_pct}}% Mappable</b></span>
      </div>
    </div></dd>
</dl>
{% if country.budgettype %}<p class="text-muted">In {{ country.text }}, we are mapping to the {{ country.budgettype.text }} budget.</p>
{% else %}
<p class="text-muted">The budget for {{ country.text }} has not yet been mapped to the Common Code.</p>
{% endif %}
<h3>Economic classification</h3>
<dl class="dl-horizontal">
  <dt>Before</dt><dd>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{stats.total_capital_before_pct}}%;">
        <span><b>{{stats.total_capital_before_pct}}% Capital</b></span>
      </div>
    </div>
  </dd>
  <dt>After</dt><dd>
    <div class="progress">
      <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{stats.total_capital_after_pct}}%; min-width:3%;">
        <span><b>{{stats.total_capital_after_pct}}% Capital</b></span>
      </div>
      <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{stats.total_current_after_pct}}%; max-width: 96%">
        <span><b>{{stats.total_current_after_pct}}% Current</b></span>
      </div><br />
    </div>  
    <p><span class="label label-warning">Capital</span> <span class="label label-success">Current</span></p>
  </dd>
</dl>
<p class="text-muted">Statistics restricted to C01, D01 and D02 aid types and activities in implementation and completion stage. Values are commitments, in donor's currency.</p>

<h2>Total spend to different budget lines</h2>
<table class="table" id="budget-lines">
  <thead>
    <th>Code</th>
    <th>Budget line</th>
    <th>Value before</th>
    <th>Value after</th>
    <th>Pct before</th>
    <th>Pct after</th>
    <th>Pct change</th>
  </thead>
  <tbody>
    {% for code, bs in budget_stats.budgets.items() %}
    <tr {% if bs.change_pct %}class="active"{% endif %}>
      <td>{{ bs.code }}</td>
      <td>{{ bs.name }}</td>
      <td>{{ bs.before.value }}</td>
      <td>{{ bs.after.value }}</td>
      <td>{{ bs.before.pct }}</td>
      <td>{{ bs.after.pct }}</td>
      <td>{{ bs.change_pct }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<h1>Projects</h1>
<table class="table" id="projects">
  <thead>
    <th class="titles-column">Title</th>
    <th class="sectors-column">Common Code</th>
    <th>Capital expenditure</th>
    <th>CC mappable before</th>
    <th>CC mappable after</th>
    <th>CC mappable diff</th>
    <th>Status</th>
    <th>Aid Type</th>
    <th>Organisations</th>
  </thead>
  <tbody>
    {% for project in projects %}
    <tr>
      <td class="titles-column"><a href="{{url_for('activities', country_code=project.recipient_country_code, iati_identifier=project.iati_identifier)}}">{% for title in project.titles %}{{title.text}}<br />{% endfor %}</a></td>
      <td class="sectors-column">
        {% for sector in project.sectors %}
        {% if sector.deleted != True %}
        {% if sector.dacsector.cc.id != "0" %}
        <span class="label label-success" title="{{sector.dacsector.cc.sector}} 
 &ndash; {{sector.dacsector.cc.function}} ({{sector.dacsector.cc.id}})">
          {{sector.dacsector.cc.sector}} &ndash; {{sector.dacsector.cc.function}}
          ({{sector.dacsector.cc.id}})</span>
        {% else %}
        <span class="label label-danger">Not mappable</span>
        {% endif %}
        </p>
        {% endif %}
        {%endfor%}
      </td>
      <td>{% if project.capital_exp is not none %}{{ project.capital_exp*100 }}%{% else %}N/A{% endif %}</td>
      <td>
        {{ project.pct_mappable_before }}
      </td>
      <td>
        {{ project.pct_mappable_after }}
      </td>
      <td>
        {{ project.pct_mappable_diff|round(2) }}
      </td>
      <td>
        {{ project.status.text }}
      </td>
      <td>
        {{ project.aid_type.text }}
      </td>
      <td>
        {% for org in project.participating_orgs %}
        {{org.organisation.name}} ({{org.role}})<br />
        {%endfor%}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
